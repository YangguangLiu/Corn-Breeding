---
title: \vspace{1in} Corn Breeding Inbred and Tester BLUP GCA Prediction Using Mixed Model in R
author: "Big Data Group"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{graphicx}
  - \usepackage{float}
  - \usepackage{titling}
  - \pagenumbering{gobble}
  - \pretitle{\begin{center}\LARGE\includegraphics[width=3in,height=3in]{MUnivlogo.jpeg}\\[\bigskipamount]}
  - \posttitle{\end{center}}
  - \let\origfigure\figure
  - \let\endorigfigure\endfigure
  - \renewenvironment{figure}[1][2] {\expandafter\origfigure\expandafter[H]} {\endorigfigure}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \setlength\headheight{28.7522pt}
  - \rhead{\includegraphics[width = .05\textwidth]{MUnivlogo.jpeg}}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: true      
    keep_tex: yes 
  html_document: default
  word_document: default
params:
  test_nrow: 5000
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = 'H')
knitr::knit_hooks$get("inline")
library(ggplot2)
library(dplyr)
library(knitr)
library(lme4)
library(emmeans)
emm_options(pbkrtest.limit = 6000)
options(digits = 3) # auto round to 3 decimals when printed
```

\newpage
&nbsp;
\pagenumbering{roman} 
\tableofcontents
\newpage

\pagenumbering{arabic}

# Introduction

Today, the agriculture industry is committed to maximizing the amount of food we gain from crops by breeding plants with the strongest and highest-yielding genetics. Plant breeding is complex, and data analytics can help scientists in R & D organizations like Bayer and Syngenta make progress in seed product development.

Commercial corn is processed into a variety of food and industrial products. It is recognized as one of the most important crops in the world. Each year, plant breeders create new corn products by crossing “parents” together, known as experimental hybrids. The parents are known as inbreds and the development of the inbreds accounted for most of the corn breeding program. Most of these efforts have been spent evaluating the inbreds by crossing to another inbred, called a “tester”.

Based on the historical hybrids performance data across years and locations, this project will create a data-driven model that can predict the overall performance of the crossing of any two inbred and tester parents, so that breeder can make a better decision on which hybrid should be provided to growers to increase productivity to meet the growing needs of the world. The final analysis report is generated by RMarkdown (RStudio, 2020).

```{r}
setwd("~/MUStudy/DSCI618ExperimentalDesign/Project")
original_data <- read.csv("./CC2020_data/CC2020_train_final.csv", stringsAsFactors = FALSE)
original_data$YEAR <- factor(original_data$YEAR)
original_data <- original_data %>% rename(Year = YEAR, Location = LOCATION, Inbred = INBRED, Inbred_Cluster = INBRED_CLUSTER, Tester = TESTER, Tester_Cluster = TESTER_CLUSTER, Yield = YIELD)
```

```{r}
train_data_stat <- original_data %>% summarise_each(list(n_distinct))
```

# Problem Statement

## Dataset

The dataset used in this project are provided by Syngenta for the 2020 Syngenta Crop Challenge in Analytics (Syngenta, 2020). The training dataset includes `r train_data_stat$Inbred` experimental inbreds and `r train_data_stat$Tester` experimental testers in `r train_data_stat$Location` locations through `r train_data_stat$Year` year of experiments. 

```{r}
filtered_test_data <- original_data[1:params$test_nrow,]
filtered_test_data_stat <- filtered_test_data %>% summarise_each(list(n_distinct))
```

There are `r nrow(original_data)` rows in the training data frame, in order to save compute time, only `r params$test_nrow` rows of data were selected in this project. The subset of the training dataset includes `r filtered_test_data_stat$Inbred` experimental inbreds and `r filtered_test_data_stat$Tester` experimental testers in `r filtered_test_data_stat$Location` of locations through `r filtered_test_data_stat$Year` years of experiments. 

Graphs of *Yield* versus the factors of *Year*, *Inbred Cluster*, and *Tester Cluster* are shown in Figure 1, Figure 2, and Figure 3, respectively.

```{r, fig.height = 2, fig.width = 6, fig.cap= "Year Boxplot"}
p_year <- ggplot(data = filtered_test_data, 
                   mapping = aes(x = reorder(Year, Yield, na.rm = TRUE), 
                                 y= Yield, fill = Year)) + 
  geom_boxplot() + labs(x = "Year", y = "Yield") +
  scale_x_discrete(labels=c("16" = "2016", "17" = "2017", "18" = "2018")) +
  coord_flip() +
  theme(legend.position = "none")
p_year
```

```{r,fig.height = 4, fig.width = 6, fig.cap= "Inbred Cluster Boxplot"}
p_inbred <- ggplot(data = filtered_test_data, 
                   mapping = aes(x = reorder(Inbred_Cluster, Yield, na.rm = TRUE), 
                                 y= Yield, fill = Inbred_Cluster)) + 
  geom_boxplot() + labs(x = "Inbred Cluster", y = "Yield") +
  coord_flip() +
  theme(legend.position = "none")
p_inbred
```

```{r,fig.height = 4, fig.width = 6, fig.cap= "Tester Cluster Boxplot"}
p_tester <- ggplot(data = filtered_test_data, 
                   mapping = aes(x = reorder(Tester_Cluster, Yield, na.rm = TRUE),
                                 y= Yield, fill = Tester_Cluster)) + 
  geom_boxplot() + labs(x = "Tester Cluster", y = "Yield") +
  coord_flip() +
  theme(legend.position = "none")
p_tester
```

The boxplots in Figures 1 to 3 show that outliers exist in the dataset. 

Outliers should be investigated carefully. Often they contain valuable information about the process being investigated or the data collection and recording process. Before considering the possibility of eliminating these points from the data, one should try to understand why they appeared and whether it is likely similar values will continue to appear. Of course, outliers are usually bad data points. 

## Model design

In order to fit a model with fixed effects and random effects, the following statistical model is given:

$$y_{ijklm}=\mu+\alpha_i+\beta_j+\gamma_k+\tau_l+\epsilon_{ijklm}$$


*	$\mu$ is the grand mean;
* $\alpha_i$ is the random effect of inbred $i$
* $\beta_j$ is the random effect of tester $j$
* $\gamma_k$ is the random effect of location $k$
* $\epsilon_{ijkl}$ is the residual of the $m^{th}$ observation in the $i^{th}$ inbred group in the $j^{th}$ tester group in the $k^{th}$ location group in the $l^{th}$ year group.


Use *Year* as a fixed effect, use *Location*, *Inbred*, and *Tester* as random effects in the mixed model, the effects of *Inbred Cluster* and *Tester Cluster* weren't considered in this model.

The summary of the model:

```{r}
model <- lmer(Yield ~ Year + (1|Location) + (1|Inbred) + (1|Tester), data = filtered_test_data)
summary(model)
```

The residual plot of the fitted model is shown in Figure 4, which shows the model data are simulated in a way that meets the model assumptions very well.

```{r, fig.height = 4, fig.width = 6, fig.cap="Residual plot of the fitted model"}
ggplot(fortify(model), aes(.fitted, .resid)) + 
  geom_point(alpha = 0.3) + 
  geom_hline(yintercept=0, col="red", linetype="dashed", size = 1) +
  xlab("Fitted values") + 
  ylab("Residuals") 
```


## Year effect

Least Squares Means (LSMEANS) are used to estimate the *Year* effect using the mixed model.

```{r}
year.lsm <- lsmeans(model, data = filtered_test_data, ~Year)
summary(year.lsm)
```

The LSMEANS are adjusted for the yield difference in each year, and there is a meaningful difference between the years. The LSMEANS of Year 2016, 2017, and 2018 are `r summary(year.lsm)[1,"lsmean"]`, `r summary(year.lsm)[2,"lsmean"]`, and `r summary(year.lsm)[3,"lsmean"]`, respectively.

```{r, include=FALSE}
ranef(model)$Tester
```

```{r, include=FALSE}
str(rr1 <- ranef(model))
```

```{r, include=FALSE}
str(dd <- as.data.frame(rr1))
```

The plot for the top 50 conditional values and conditional standard deviations of *Inbred* is shown in Figure 5.

```{r, fig.height = 10.5, fig.width= 8, fig.cap="Inbred's top 50 conditional values and corresponding standard deviations"}
dd_inbred <- dd %>% filter(grpvar == "Inbred") %>% top_n(50, condval)
ggplot(dd_inbred, aes(y=grp,x=condval)) +
        geom_point() + labs(x = NULL, y = NULL) +
        geom_errorbarh(aes(xmin=condval -2*condsd,
                           xmax=condval +2*condsd), height=0)
```

The plot for conditional value and conditional standard deviations of *Tester* is shown in Figure 6.

```{r,fig.height = 8, fig.width= 8, fig.cap="Tester's conditional value and corresponding standard deviations"}
dd_tester <- dd %>% filter(grpvar == "Tester")
ggplot(dd_tester, aes(y=grp,x=condval)) +
        geom_point() + labs(x = NULL, y = NULL) +
        geom_errorbarh(aes(xmin=condval -2*condsd,
                           xmax=condval +2*condsd), height=0)
```

# Results

## Yield prediction of *Inbred* and *Tester*

The yields of the crossing *inbred* and *tester* are predicted by the fitted model. 

```{r}
predict_test_data <- filtered_test_data
predict_test_data$Predict_Yield <- predict(model)
```

Predicted yield means of *Inbreds* with different inbred clusters are shown in Table 1.

```{r}
inbred_pred_yield_means <- predict_test_data %>% 
  group_by(Inbred_Cluster, Inbred) %>% 
  summarise(n = n(), Inbred_Pred_Yield_Mean = mean(Predict_Yield)) %>% 
  arrange(desc(Inbred_Pred_Yield_Mean))

kable(inbred_pred_yield_means,
             caption = "Predicted yield means of inbreds with different clusters") 
```

Predicted yield means of *Testers* with different tester clusters are shown in Table 2.

```{r}
tester_pred_yield_means <- predict_test_data %>% 
  group_by(Tester_Cluster, Tester) %>% 
  summarise(n = n(), Tester_Pred_Yield_Mean = mean(Predict_Yield)) %>% 
  arrange(desc(Tester_Pred_Yield_Mean))

kable(tester_pred_yield_means,
             caption = "Predicted yield means of testers with different clusters") 
```

Top 50 corn hybrids in the selected training data are shown in Table 3.

```{r}
df_filtered <- filtered_test_data %>% select(Tester, Inbred, Yield) %>% 
  group_by(Tester, Inbred) %>% summarise(Yield = mean(Yield)) %>% arrange(desc(Yield)) %>% 
  ungroup %>% top_n(50, Yield)

df_filtered$Yield <- format((round(df_filtered$Yield, 3)), nsmall = 3)

kable(df_filtered, caption = "Top 50 Corn Hybrids in Training Data") 
```

## Top corn hybrids prediction

The inbred and tester's performances were predicted in the above section, new corn hybrids not existed in the training data file were further explored by combining good *Inbred* and good *Tester*. The top 50 corn hybrids predicted by the fitted model were shown in Table 4.

```{r, message = FALSE}
tester_df <- tester_pred_yield_means %>% select(Tester, Tester_Yield =Tester_Pred_Yield_Mean)
inbred_df <- inbred_pred_yield_means %>% select(Inbred, Inbred_Yield=Inbred_Pred_Yield_Mean)
# cross join two tables
df_merge <- merge(tester_df, inbred_df, by = NULL) %>% select(Tester, Inbred, Tester_Yield, Inbred_Yield) 
df_merge <- mutate(df_merge, Pred_Yield = rowMeans(select(df_merge, ends_with("Yield")))) %>% 
  select(Tester, Inbred, Pred_Yield) %>% 
  arrange(desc(Pred_Yield))
```

```{r}
#drops all observations in left dataframe that match in right dataframe.
df_hybrids <- anti_join(df_merge, df_filtered, by = c("Tester", "Inbred")) %>% top_n(50, Pred_Yield)

df_hybrids$Pred_Yield <- format((round(df_hybrids$Pred_Yield, 3)), nsmall = 3)

kable(df_hybrids, caption = "Top 50 Predicted Corn Hybrids") 
```

# Conclusion

The performance of the crossing of any two inbred and tester pareents were predicted by a mixed model. Then, the overall mean of any *inbred* and *tester* were calculated respectively. The results show that the best five inbreds are `r inbred_pred_yield_means$Inbred[1]`, `r inbred_pred_yield_means$Inbred[2]`, `r inbred_pred_yield_means$Inbred[3]`, `r inbred_pred_yield_means$Inbred[4]`, and `r inbred_pred_yield_means$Inbred[5]`, while the best five testers are `r tester_pred_yield_means$Tester[1]`, `r tester_pred_yield_means$Tester[2]`, `r tester_pred_yield_means$Tester[3]`, `r tester_pred_yield_means$Tester[4]`, and `r tester_pred_yield_means$Tester[5]`. 

Yield is very important when selecting a corn hybrid. Its yield can be calcualted by calculating the average of the inbred and tester yields. We can see that the top 5 hybrid performance of the crossing of `r df_hybrids$Tester[1]` and `r df_hybrids$Inbred[1]`, `r df_hybrids$Tester[2]` and `r df_hybrids$Inbred[2]`, `r df_hybrids$Tester[3]` and `r df_hybrids$Inbred[3]`, `r df_hybrids$Tester[4]` and `r df_hybrids$Inbred[4]`, `r df_hybrids$Tester[5]` and `r df_hybrids$Inbred[5]`. 


# References

Syngenta, 2020. "2020 Syngenta Crop Challenge in Analytics". Weblink:[https://www.ideaconnection.com/syngenta-crop-challenge/challenge.php](https://www.ideaconnection.com/syngenta-crop-challenge/challenge.php).

RStudio, 2020. "R Markdown from RStudio". Weblink:[https://rmarkdown.rstudio.com/index.html](https://rmarkdown.rstudio.com/index.html).
